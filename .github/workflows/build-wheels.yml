name: Build Wheels

on:
  push:
    tags:
      - 'v*'
    branches:
      - develop

  pull_request:
    types:
      - opened
      - synchronize
    branches:
      - develop

jobs:
  build-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ macOS-latest ]
    env:
      CIBW_BUILD: "cp310*-*"
      CIBW_ARCHS: native
      CIBW_BUILD_FRONTEND: build
      MACOSX_DEPLOYMENT_TARGET: "10.14"
#      CIBW_REPAIR_WHEEL_COMMAND_MACOS: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Cache Vcpkg
        uses: actions/cache@v2
        id: cache-vcpkg
        with:
          path: /usr/local/share/vcpkg/installed
          key: ${{ runner.os }}-vcpkg

      - name: Install Vcpkg Dependencies
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -e
          cp -rv .vcpkg/ports/* /usr/local/share/vcpkg/ports
          vcpkg install lz4 lexbor uchardet zlib

      - name: Build Resiliparse
        uses: pypa/cibuildwheel@v2.1.1
        env:
          CPATH: /usr/local/share/vcpkg/installed/x64-osx/include
          LIBRARY_PATH: /usr/local/share/vcpkg/installed/x64-osx/lib

          # This has no effect
          DYLD_LIBRARY_PATH: /usr/local/share/vcpkg/installed/x64-osx/lib

          # But this doesn't work either...
          CIBW_ENVIRONMENT: >-
            BUILD_PACKAGES=resiliparse
            DYLD_LIBRARY_PATH=/usr/local/share/vcpkg/installed/x64-osx/lib

          # ...as we can show here
          CIBW_BEFORE_BUILD: "env | grep LIBRARY"
